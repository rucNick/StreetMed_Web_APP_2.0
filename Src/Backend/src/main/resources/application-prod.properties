# ==============================================
# Production Configuration for Google Cloud Run
# ==============================================
spring.application.name=StreetMed_Backend
server.port=${PORT:8080}
server.address=0.0.0.0
server.shutdown=graceful

# ==============================================
# TLS/SSL - DISABLED for Cloud Run
# Cloud Run handles TLS termination at the load balancer
# ==============================================
server.ssl.enabled=false

# ==============================================
# Session Configuration
# ==============================================
spring.session.timeout=30m
server.servlet.session.timeout=30m
# Note: secure cookies work because Cloud Run provides HTTPS externally
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.http-only=true

# ==============================================
# CORS Configuration
# ==============================================
cors.allowed-origins=${CORS_ALLOWED_ORIGINS:https://streetmed-frontend-900663028964.us-central1.run.app,http://localhost:3000,https://app.streetmedatpitt.org}

# ==============================================
# Cloud SQL MySQL Configuration
# Uses Unix socket connection via Cloud SQL Connector
# ==============================================
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# Option 1: Using Cloud SQL Socket Factory (recommended)
# Requires: mysql-socket-factory-connector-j-8 dependency in pom.xml
spring.datasource.url=jdbc:mysql:///${MYSQL_DATABASE:streetmed}?cloudSqlInstance=${CLOUD_SQL_INSTANCE:streetmedgo:us-central1:streetmed}&socketFactory=com.google.cloud.sql.mysql.SocketFactory&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true

# Option 2: Using Unix socket path directly (alternative if Option 1 doesn't work)
# Cloud Run mounts Cloud SQL socket at /cloudsql/<instance-connection-name>
# spring.datasource.url=jdbc:mysql:///streetmed?unixSocketPath=/cloudsql/streetmedgo:us-central1:streetmed&serverTimezone=UTC

spring.datasource.username=${MYSQL_USER}
spring.datasource.password=${MYSQL_PASSWORD}

# ==============================================
# Hikari Connection Pool Configuration
# Optimized for Cloud Run (serverless, connections may be limited)
# ==============================================
spring.datasource.hikari.pool-name=CloudRunMySQLHikariCP
spring.datasource.hikari.minimum-idle=2
spring.datasource.hikari.maximum-pool-size=5
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.max-lifetime=1200000
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.leak-detection-threshold=60000

# ==============================================
# JPA Configuration for MySQL
# ==============================================
spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
spring.jpa.show-sql=false
spring.jpa.hibernate.ddl-auto=update
spring.jpa.open-in-view=false
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.properties.hibernate.current_session_context_class=thread

# ==============================================
# MongoDB Atlas Configuration
# ==============================================
spring.data.mongodb.uri=${MONGODB_URI}
spring.data.mongodb.database=${MONGODB_DATABASE:streetmed}

# ==============================================
# Multithreading Configuration
# ==============================================
spring.task.execution.pool.core-size=4
spring.task.execution.pool.max-size=8
spring.task.execution.pool.queue-capacity=100
spring.task.execution.thread-name-prefix=StreetMed-Task-
spring.task.execution.shutdown.await-termination=true
spring.task.execution.shutdown.await-termination-period=20s

# ==============================================
# Graceful Shutdown
# ==============================================
spring.lifecycle.timeout-per-shutdown-phase=20s

# ==============================================
# Swagger/OpenAPI (consider disabling in production)
# ==============================================
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.api-docs.path=/api-docs
# Uncomment to disable in production:
# springdoc.api-docs.enabled=false
# springdoc.swagger-ui.enabled=false

# ==============================================
# File Upload Settings
# ==============================================
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB

# ==============================================
# Email Configuration
# ==============================================
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=${MAIL_USERNAME:streetmedgo@gmail.com}
spring.mail.password=${MAIL_PASSWORD}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true

# ==============================================
# Security Configuration
# ==============================================
# Disable custom encryption in production (TLS handles it)
security.use.custom.encryption=false
security.client.authentication.key=${CLIENT_AUTH_KEY:street-med-client-authentication-key}
security.client.validation.relaxed=false
auth.dev.token.enabled=true

# ==============================================
# TLS Service Configuration
# ==============================================
tls.enforce.admin=false
tls.allow.http.in.dev=false

# ==============================================
# Logging Configuration (Production)
# ==============================================
logging.level.root=INFO
logging.level.com.backend.streetmed_backend=INFO
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.orm.connections.pooling=WARN
logging.level.com.zaxxer.hikari=INFO

# Exclude unused auto-configurations
spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration